# 套利策略流程（通俗版）

目标：当两个交易所价格出现明显差距时，低买高卖；差距缩小时再平仓。

## 先说明几个词（尽量通俗）
- 价差：两边价格的差。
- 基准价：Paradex 的中间价（买一和卖一的中间）。
- 做多方向：买 Paradex、卖 Lighter（因为 Lighter 更贵）。
- 做空方向：卖 Paradex、买 Lighter（因为 Paradex 更贵）。
- 入场线：触发开仓的门槛（平均价差 + 波动 * 系数）。
- 离场线：触发平仓的门槛（通常低于入场线）。
- 分层/档位：价差越大，开仓量越大。

## 策略流程（按顺序）
1. 取两边价格（Lighter 买一/卖一，Paradex 中间价）。
2. 算两种价差：
   - 向上价差 = Lighter 买一 - Paradex 中间价
   - 向下价差 = Paradex 中间价 - Lighter 卖一
3. 用最近一段时间的平均价差和波动，算“入场线”和“离场线”。
4. 若向上价差超过入场线 → 走做多方向。
5. 若向下价差超过入场线 → 走做空方向。
6. 价差越大，目标仓位越大（分层/档位）。
7. 价差回落到离场线以下 → 逐步减仓，直到 0。
8. 超过最大仓位上限就不再加仓。
9. 若净仓位偏离太大，暂停开新仓等待回归。

## 用例（不同情况）
示例 A：Lighter 更贵，触发做多
- 最近平均差=2，波动=1，入场线=3.5（2+1*1.5）
- 实际向上价差=5 → 触发做多
- 目标仓位从 0 增到 3 档（封顶）

示例 B：价差继续扩大，分层加仓
- 向上价差从 5 变到 6.5
- 目标仓位从 3 档提高到 4 档（若未超过上限）

示例 C：价差回落，减仓/平仓
- 向上价差回落到离场线以下
- 目标仓位回到 0 → 逐步平仓

示例 D：两边都超过入场线
- 向上/向下价差都很大
- 策略优先选择“更强的一边”作为方向

示例 E：样本不足，用固定阈值
- 刚启动时历史数据少
- 用 --long-threshold / --short-threshold 作为入场线

示例 F：达到最大仓位
- 目标仓位算出来是 5 档，但 max_position 只允许 3
- 实际目标仓位被限制到 3 档

示例 G：净仓位偏离过大
- 当前净仓位明显超出安全范围
- 暂停开新仓，等待仓位回归
